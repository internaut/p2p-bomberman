var lounge;var game;var gameMode;var joinId;var updateLoop;var framerate=60;function init(a){if(a==="lounge"){loadLounge()}else{if(a==="game"){loadGame()}}}function loadLounge(){console.log("Loading lounge...");gameMode=parseInt(getURLParamByName("mode"));var a=getURLParamByName("join_id");if(a===undefined||a===""){joinId=0}else{joinId=a;gameMode=GameModeMultiPlayer}lounge=new LoungeClass(gameMode);lounge.setup(joinId)}function loadGame(){console.log("Loading game...");postGameStartCallback.fn.call(postGameStartCallback.obj)}var Conf={maxNumPlayers:4,maxBombStrength:5,upgradePossibility:0.25,bombTimerMs:2000,moveKeyRepeatTimeMs:100,bombKeyRepeatTimeMs:500,peerJsHost:"localhost",peerJsPort:9000,peerJsDebug:true,arrowKeyMapping:new Array("left","right","up","down","b"),wsadKeyMapping:new Array("a","d","w","s","x")};Array.prototype.shuffle=function(){var b,c;for(var a=0;a<this.length;a++){c=Math.floor(Math.random()*this.length);b=this[a];this[a]=this[c];this[c]=b}};window.requestAnimFrame=(function(a){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(b){window.setTimeout(b,1000/framerate)}})();function currentMs(){return new Date().getTime()}function defaultErrorFn(a){console.error(a)}function getURLParamByName(a){a=a.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var c=new RegExp("[\\?&]"+a+"=([^&#]*)"),b=c.exec(location.search);return b==null?"":decodeURIComponent(b[1].replace(/\+/g," "))}var GameModeSinglePlayer=0;var GameModeMultiPlayer=1;function GameClass(a){this._view=null;this._map=null;this._controls=null;this._playerManager=null;this._p2pComm=null;this._mode=a}GameClass.prototype.setup=function(b,a){this._view=new ViewClass();this._map=new MapClass();this._controls=new Array();this._p2pComm=a;if(b===null){this._playerManager=new PlayerManagerClass()}else{this._playerManager=b}this._view.setup(MapDimensions.w,MapDimensions.h);this._map.setup(this._view);if(gameMode===GameModeMultiPlayer){this._map.setP2PComm(this._p2pComm)}this._playerManager.setup(this._map,this._p2pComm)};GameClass.prototype.startGame=function(){this._view.addEntity(this._map);if(this._mode===GameModeSinglePlayer){var f=new PlayerClass(PlayerTypeLocalKeyboardArrows);f.setup(this._view,this._playerManager,null);this._view.addEntity(f);this._playerManager.addPlayer(f);var h=new ControlsClass();h.setup(f,Conf.arrowKeyMapping);this._controls.push(h);var d=new PlayerClass(PlayerTypeLocalKeyboardWSAD);d.setup(this._view,this._playerManager,null);this._view.addEntity(d);this._playerManager.addPlayer(d);var g=new ControlsClass();g.setup(d,Conf.wsadKeyMapping);this._controls.push(g)}else{var c=this._playerManager.getLocalPlayer();var a=new ControlsClass();a.setup(c,Conf.arrowKeyMapping);this._controls.push(a);this._playerManager.setupPlayers(this._view,lounge._p2pComm);var e=this._playerManager.getPlayers();for(var b=0;b<e.length;b++){this._view.addEntity(e[b])}}this._playerManager.spawnAllPlayers();this.frame()};GameClass.prototype.stopGame=function(){};GameClass.prototype.roundEnded=function(){console.log("round ended")};GameClass.prototype.frame=function(){this._view.update();requestAnimFrame(function(){this.frame()}.bind(this))};var MsgTypeKnownPeers=0;var MsgTypePlayerMetaData=1;var MsgTypePlayerPos=2;var MsgTypePlayerSpawnPoint=3;var MsgTypePlayerBomb=4;var MsgTypePlayerUpgrade=5;function P2PCommClass(){this._peer=null;this._conn=null;this._peerId="";this._msgHandler=new Object();this._connEstablishingHandler=new Array();this._connOpenedHandler={obj:null,fn:null};this._connClosedHandler={obj:null,fn:null}}P2PCommClass.prototype.setup=function(){this.setMsgHandler(MsgTypeKnownPeers,this,this._receiveKnownPeers)};P2PCommClass.prototype.getPeer=function(){return this._peer};P2PCommClass.prototype.getPeerId=function(){return this._peerId};P2PCommClass.prototype.createPeer=function(a,b){this._peer=new Peer({host:Conf.peerJsHost,port:Conf.peerJsPort,debug:Conf.peerJsDebug});this._peer.on("open",function(c){console.log("created peer with id "+c);this._peerId=c;a.call(this,c)}.bind(this));this._peer.on("error",function(c){this._peerId="";defaultErrorFn.call(this,c);b.call(this,c)}.bind(this));this._peer.on("connection",function(c){this._incomingConnection(c)}.bind(this));this._peer.on("close",function(){console.log("connection to peer server closed")}.bind(this));this._conn=this._peer.connections};P2PCommClass.prototype.joinPeer=function(a){console.log("trying to join peer "+a);var b=this._connEstablishingHandler[0];b.fn.call(b.obj,a);var c=this._peer.connect(a);c.on("open",function(){console.log("opened connection to peer "+c.peer);var d=this._connEstablishingHandler[1];d.fn.call(d.obj,c.peer)}.bind(this));c.on("error",function(e){defaultErrorFn.call(this,e);var d=this._connEstablishingHandler[2];d.fn.call(d.obj)}.bind(this));this._setupConnectionHandlers(c)};P2PCommClass.prototype.disconnectFromPeer=function(a){console.log("closing connection to peer "+a);this._conn[a].peerjs.close()};P2PCommClass.prototype.setMsgHandler=function(c,d,a,f){f=(typeof f==="undefined")?false:f;var e={fn:a,obj:d};if(f){console.log("adding msg handler for type "+c);if(this._msgHandler[c] instanceof Array===false){var b=null;if(typeof this._msgHandler[c]!=="undefined"){b=this._msgHandler[c]}this._msgHandler[c]=new Array();if(b){this._msgHandler[c].push(b);console.log("pushed old handler:"+b)}}this._msgHandler[c].push(e);console.log("pushed new handler:"+e)}else{this._msgHandler[c]=e}};P2PCommClass.prototype.setConnEstablishingHandler=function(c,d,b,a){this._connEstablishingHandler.push({obj:c,fn:d});this._connEstablishingHandler.push({obj:c,fn:b});this._connEstablishingHandler.push({obj:c,fn:a})};P2PCommClass.prototype.setConnOpenedHandler=function(b,a){this._connOpenedHandler.obj=b;this._connOpenedHandler.fn=a};P2PCommClass.prototype.setConnClosedHandler=function(b,a){this._connClosedHandler.obj=b;this._connClosedHandler.fn=a};P2PCommClass.prototype.sendPlayerMetaData=function(e,a,b,d){var c={type:MsgTypePlayerMetaData,id:a,name:b,status:d};if(e===0){this.sendAll(c)}else{this.sendTo(e,c)}};P2PCommClass.prototype.sendAll=function(b){console.log("sending message of type "+b.type+" to all");for(var a in this._conn){var d=this._conn[a].peerjs;d.send(b)}};P2PCommClass.prototype.sendTo=function(b,a){this._conn[b].peerjs.send(a)};P2PCommClass.prototype.sendKnownPeers=function(b){var c=new Array();for(var a in this._conn){c.push(a)}console.log("sending known peers to peer "+b);this.sendTo(b,{type:MsgTypeKnownPeers,peers:c})};P2PCommClass.prototype._incomingConnection=function(a){if(a.peer===undefined){return}console.log("received new connection from "+a.peer);this._setupConnectionHandlers(a)};P2PCommClass.prototype._receiveKnownPeers=function(c,d){console.log("received known peers from peer "+c.peer);for(var b=0;b<d.peers.length;b++){var a=d.peers[b];if(a===this._peerId){continue}console.log("> "+a);if(!this._conn.hasOwnProperty(a)){console.log(">> new! Connecting...");this.joinPeer(a);this._setupConnectionHandlers(c)}}};P2PCommClass.prototype._setupConnectionHandlers=function(a){a.on("open",function(){console.log("opened connection to peer "+a.peer);this._connOpenedHandler.fn.call(this._connOpenedHandler.obj,a.peer)}.bind(this));a.on("error",function(b){defaultErrorFn.call(this,b)}.bind(this));a.on("data",function(b){this._incomingData(a,b)}.bind(this));a.on("close",function(b){console.log("connection closed from peer "+b);this._connClosedHandler.fn.call(this._connClosedHandler.obj,b)}.bind(this,a.peer))};P2PCommClass.prototype._incomingData=function(b,c){if(!c||!c.hasOwnProperty("type")){return}console.log("received data from "+b.peer+" with type "+c.type);var d=this._msgHandler[c.type];if(d){if(d instanceof Array===true){for(var a=0;a<d.length;a++){d[a].fn.call(d[a].obj,b,c)}}else{d.fn.call(d.obj,b,c)}}else{console.err("no msg handler for type "+c.type)}};function EntityClass(){this.x=0;this.y=0;this._view=null}EntityClass.prototype.setup=function(a){this._view=a};EntityClass.prototype.set=function(a,b){this.x=a;this.y=b};EntityClass.prototype.draw=function(){};var PlayerStatusNotReady=1;var PlayerStatusReady=2;var PlayerTypeLocalKeyboardArrows=0;var PlayerTypeLocalKeyboardWSAD=1;var PlayerTypeLocalAI=2;var PlayerTypeRemote=3;var PlayerColors=new Array("gold","blue","deeppink","lime");PlayerClass.prototype=new EntityClass();PlayerClass.constructor=PlayerClass;PlayerClass.prototype.parent=EntityClass.prototype;function PlayerClass(a){this._margin=5;this._color=PlayerColors[0];this._id=0;this._name="";this._alive=true;this._status=PlayerStatusNotReady;this._type=a;this._spawnPoint=null;this._playerManager=null;this._p2pComm=null;this._bombStrength=1}PlayerClass.prototype.setup=function(b,a,c){this.parent.setup.call(this,b);this._playerManager=a;if(c){this._p2pComm=c;this._p2pComm.setMsgHandler(MsgTypePlayerPos,this,this.receivePos,true);this._p2pComm.setMsgHandler(MsgTypePlayerBomb,this,this.receiveBomb,true)}};PlayerClass.prototype.getType=function(){return this._type};PlayerClass.prototype.setType=function(a){this._type=a;return this};PlayerClass.prototype.setAlive=function(a){this._alive=a;return this};PlayerClass.prototype.getAlive=function(){return this._alive};PlayerClass.prototype.getName=function(){return this._name};PlayerClass.prototype.setName=function(a){this._name=a;return this};PlayerClass.prototype.getId=function(){return this._id};PlayerClass.prototype.setId=function(a){this._id=a;return this};PlayerClass.prototype.getStatus=function(){return this._status};PlayerClass.prototype.setStatus=function(a){this._status=a;return this};PlayerClass.prototype.getColor=function(){return this._color};PlayerClass.prototype.setColor=function(a){this._color=a;return this};PlayerClass.prototype.setSpawnPoint=function(a){this._spawnPoint=new Array(a[0],a[1]);this.set(a[0],a[1]);return this};PlayerClass.prototype.getSpawnPoint=function(){return this._spawnPoint};PlayerClass.prototype.getBombStrength=function(){return this._bombStrength};PlayerClass.prototype.increaseBombStrength=function(){if(this._bombStrength<Conf.maxBombStrength){this._bombStrength++;console.log("bomb strength of player "+this._id+" is now "+this._bombStrength)}};PlayerClass.prototype.draw=function(){if(this._alive){this._view.drawCellRhombus(this.x,this.y,this._margin,this._color)}};PlayerClass.prototype.moveBy=function(c,a){if(!this._alive){return}var d=this.x+c;var b=this.y+a;if(d<0||d>=MapDimensions.w){d=this.x}if(b<0||b>=MapDimensions.h){b=this.y}if(mapCellIsFree(d,b)){if(gameMode===GameModeMultiPlayer){this.sendPos(d,b)}this.set(d,b);this._checkDestinationCell(d,b)}};PlayerClass.prototype.dropBomb=function(){if(!this._alive||mapCellType(this.x,this.y)==="B"){return}if(gameMode===GameModeMultiPlayer){this.sendBombDrop(this.x,this.y)}this._dropBombByPlayer(this)};PlayerClass.prototype._dropBombByPlayer=function(a){var b=new BombClass();b.setup(this._view,this._playerManager,this._p2pComm);b.dropByPlayer(a)};PlayerClass.prototype.sendPos=function(a,c){if(this._type===PlayerTypeRemote){return}var b={id:this._id,type:MsgTypePlayerPos,pos:new Array(a,c)};this._p2pComm.sendAll(b)};PlayerClass.prototype.receivePos=function(a,b){if(this._type!==PlayerTypeRemote||b.id!==this._id){return}this.set(b.pos[0],b.pos[1]);this._checkDestinationCell(b.pos[0],b.pos[1])};PlayerClass.prototype.sendBombDrop=function(a,c){if(this._type===PlayerTypeRemote){return}var b={id:this._id,type:MsgTypePlayerBomb};this._p2pComm.sendAll(b)};PlayerClass.prototype.receiveBomb=function(a,b){if(this._type!==PlayerTypeRemote||b.id!==this._id){return}this._dropBombByPlayer(this)};PlayerClass.prototype._checkDestinationCell=function(b,a){if(mapCellType(b,a)==="U"){this.increaseBombStrength();mapCellSet(b,a," ")}};function PlayerManagerClass(){this._localPlayer=null;this._players=new Object();this._map=null;this._p2pComm=null;this._chooseSpawnPointTimeoutHndl=null;this._playersSpawned=false}PlayerManagerClass.prototype.setup=function(b,a){this._map=b;this._p2pComm=a};PlayerManagerClass.prototype.getPlayers=function(){var a=$.map(this._players,function(b){return b});return a};PlayerManagerClass.prototype.getPlayer=function(a){return this._players[a]};PlayerManagerClass.prototype.getLocalPlayer=function(){return this._localPlayer};PlayerManagerClass.prototype.playerExists=function(a){return this._players.hasOwnProperty(a)};PlayerManagerClass.prototype.setupPlayers=function(b,a){for(var c in this._players){this._players[c].setup(b,this,a)}};PlayerManagerClass.prototype.addPlayer=function(a){this._players[a.getId()]=a;if(a.getType()===PlayerTypeLocalKeyboardArrows||a.getType()===PlayerTypeLocalKeyboardWSAD){this._localPlayer=a}};PlayerManagerClass.prototype.removePlayer=function(a){if(this._players.hasOwnProperty(a)){delete this._players[a]}};PlayerManagerClass.prototype.checkGameStatus=function(){var b=0;for(var a in this._players){if(this._players[a].getAlive()===true){b++}}if(b===0){game.roundEnded()}};PlayerManagerClass.prototype.spawnAllPlayers=function(){var a=this._map.getSpawnPoints().slice();if(a.length<this._players.length){console.error("More players than spawn points on this map!");return}if(gameMode===GameModeSinglePlayer){this._spawnAllPlayersSP(a)}else{this._spawnAllPlayersMP()}};PlayerManagerClass.prototype._spawnAllPlayersSP=function(b){b.shuffle();var a=0;for(var c in this._players){this.spawnPlayer(this._players[c],b[a++])}};PlayerManagerClass.prototype._spawnAllPlayersMP=function(){this._p2pComm.setMsgHandler(MsgTypePlayerSpawnPoint,this,this._spawnPointMsgReceived);this._playersSpawned=false;var a=Math.random()*800+200;this._chooseSpawnPointTimeoutHndl=window.setTimeout(function(){this._chooseSpawnPoints()}.bind(this),a)};PlayerManagerClass.prototype._chooseSpawnPoints=function(){if(this._playersSpawned){return}this._playersSpawned=true;var b=this._map.getSpawnPoints().slice();b.shuffle();var a=0;var d=new Object();for(var f in this._players){var c=b[a++];d[f]=c;this._players[f].setSpawnPoint(c)}var e={id:this._localPlayer.getId(),type:MsgTypePlayerSpawnPoint,spawnPts:d};console.log("sending spawn point message to all");this._p2pComm.sendAll(e)};PlayerManagerClass.prototype._spawnPointMsgReceived=function(a,c){if(this._playersSpawned){return}this._playersSpawned=true;window.clearTimeout(this._chooseSpawnPointTimeoutHndl);console.log("received spawn point message");var b=c.spawnPts;for(var d in b){console.log("setting player "+this._players[d].getName()+" to "+b[d][0]+","+b[d][1]);this.spawnPlayer(this._players[d],b[d])}};PlayerManagerClass.prototype.spawnPlayer=function(b,a){b.setAlive(true);b.setSpawnPoint(a)};var postGameStartCallback=null;function LoungeClass(a){this._gameMode=a;this._p2pComm=null;this._playerManager=null;this._ownPlayer=null}LoungeClass.prototype.setup=function(a){console.log("Setting up lounge in mode "+this._gameMode+" and join id "+a);postGameStartCallback={obj:this,fn:this._startGame};if(this._gameMode===GameModeSinglePlayer){this._setupSP()}else{this._setupMP(a)}};LoungeClass.prototype._setupSP=function(){$("#singleplayer_conf").show();$("#singleplayer_start_btn").click(function(){$("#lounge").hide();init("game")}.bind(this))};LoungeClass.prototype._setupMP=function(a){$("#multiplayer_conf").show();$("#playerlist").show();$("#name").attr("disabled");$("#name").change(function(){this._nameChanged($("#name").val())}.bind(this));$("#ready").change(function(){this._statusChanged($("#ready:checked").val())}.bind(this));this._playerManager=new PlayerManagerClass();this._p2pComm=new P2PCommClass();this._p2pComm.setup();$("#player_conn_status").text("receiving peer id...");this._p2pComm.createPeer(function(b){this.player_id=b;$("#player_id").text(this.player_id);$("#player_conn_status").text("awaiting connections");$("#player_conn_status").removeClass("status_unknown").addClass("ok");this._postConnectionSetup();if(a!==0){this._p2pComm.joinPeer(a)}}.bind(this),function(b){$("#player_conn_status").text("oops!");$("#player_conn_status").removeClass("status_unknown").addClass("not_ok")}.bind(this))};LoungeClass.prototype._startGame=function(){game=new GameClass(this._gameMode);if(this._gameMode===GameModeSinglePlayer){game.setup(null,null)}else{game.setup(this._playerManager,this._p2pComm)}$("#main > h1").hide();game.startGame();$("#game").show()};LoungeClass.prototype._joiningPeer=function(a){$("#player_conn_status").text("joining "+a+"...")};LoungeClass.prototype._joinedPeer=function(a){$("#player_conn_status").text("awaiting connections");this._sendOwnStatus(a)};LoungeClass.prototype._errorJoiningPeer=function(a){$("#player_conn_status").text("oops! error joining!");$("#player_conn_status").removeClass("status_unknown").addClass("not_ok")};LoungeClass.prototype._postConnectionSetup=function(){this._ownPlayer=new PlayerClass(PlayerTypeLocalKeyboardArrows);var a=this._p2pComm.getPeerId();var b="player_"+a;this._ownPlayer.setId(a).setName(b);this._playerManager.addPlayer(this._ownPlayer);$("#name").val(b);$("#name").removeAttr("disabled");this._p2pComm.setConnEstablishingHandler(this,this._joiningPeer,this._joinedPeer,this._errorJoiningPeer);this._p2pComm.setConnOpenedHandler(this,this._playerConnected);this._p2pComm.setConnClosedHandler(this,this._playerDisconnected);this._p2pComm.setMsgHandler(MsgTypePlayerMetaData,this,this._receivedPlayerMetaData);this._addPlayerToList(a,b,this._ownPlayer.getColor())};LoungeClass.prototype._addPlayerToList=function(h,d,b){var c=$("#playerlist_id_"+h);if(b===null){if(this._playerManager.playerExists(h)){this._playerManager.removePlayer(h);if(c){c.detach()}}var f=new PlayerClass(PlayerTypeRemote);f.setId(h).setName(d);b=PlayerColors[this._playerManager.getPlayers().length];f.setColor(b);this._p2pComm.setMsgHandler(MsgTypePlayerPos,this._ownPlayer,this._ownPlayer.receivePos);this._playerManager.addPlayer(f)}var g=$("#playerlist > ul");var a="playerlist_id_"+h;var e='<li id="'+a+'" class="not_ok"><span style="background-color:'+b+'">&nbsp;&nbsp;&nbsp;</span>&nbsp;'+d+"</li>";g.append(e)};LoungeClass.prototype._updatePlayerList=function(b,f,g){this._playerManager.getPlayer(b).setName(f).setStatus(g);var c=this._playerManager.getPlayers();var j=0;var a=c.length;for(var h=0;h<a;h++){if(c[h].getStatus()===PlayerStatusReady){j++}}if(j===a){$("#lounge").hide();init("game")}var e=$("#playerlist_id_"+b);var d=e.children();e.html("&nbsp;"+f).prepend(d);if(g===PlayerStatusNotReady){e.removeClass("ok").addClass("not_ok")}else{if(g===PlayerStatusReady){e.removeClass("not_ok").addClass("ok")}}};LoungeClass.prototype._nameChanged=function(a){this._ownPlayer.setName(a);this._sendOwnStatus(0);this._updatePlayerList(this._ownPlayer.getId(),this._ownPlayer.getName(),this._ownPlayer.getStatus())};LoungeClass.prototype._statusChanged=function(b){var a=PlayerStatusNotReady;if(b==="ready"){a=PlayerStatusReady}this._ownPlayer.setStatus(a);this._sendOwnStatus(0);this._updatePlayerList(this._ownPlayer.getId(),this._ownPlayer.getName(),this._ownPlayer.getStatus())};LoungeClass.prototype._receivedPlayerMetaData=function(a,b){if(this._playerManager.playerExists(b.id)){this._updatePlayerList(b.id,b.name,b.status)}else{if(this._playerManager.getPlayers().length>=Conf.maxNumPlayers){console.log("too many players - closing connection!");this._p2pComm.disconnectFromPeer(b.id)}else{this._p2pComm.sendKnownPeers(b.id);this._sendOwnStatus(b.id);this._addPlayerToList(b.id,b.name,null)}}};LoungeClass.prototype._sendOwnStatus=function(a){this._p2pComm.sendPlayerMetaData(a,this._ownPlayer.getId(),this._ownPlayer.getName(),this._ownPlayer.getStatus())};LoungeClass.prototype._playerConnected=function(a){console.log("player connected: "+a);this._sendOwnStatus(a)};LoungeClass.prototype._playerDisconnected=function(a){console.log("player disconnected: "+a);var b=$("#playerlist_id_"+a);if(this._playerManager.playerExists(a)){this._playerManager.removePlayer(a);if(b){b.detach()}}};function ViewClass(){this._canvas=document.getElementById("canvas");this._ctx=this._canvas.getContext("2d");this._entities=new Array();this.w=this._canvas.width;this.h=this._canvas.height;this.rows=0;this.cols=0;this.cellW=0;this.cellH=0}ViewClass.prototype.setup=function(a,b){this.rows=a;this.cols=b;this.cellW=this.w/(this.cols);this.cellW_2=this.cellW/2;this.cellH=this.h/(this.rows);this.cellH_2=this.cellH/2;console.log("Drawing "+this.cols+" x "+this.rows+" grid with cells size "+this.cellW+" x "+this.cellH)};ViewClass.prototype.addEntity=function(b){for(var a=0;a<this._entities.length;a++){if(this._entities[a]===b){return}}this._entities.push(b)};ViewClass.prototype.addEntityBeforeEntity=function(b,d){for(var a=0;a<this._entities.length;a++){var c=this._entities[a];if(c===d){this._entities.splice(a,0,b);return}}this.addEntity(b)};ViewClass.prototype.removeEntity=function(b){for(var a=0;a<this._entities.length;a++){if(this._entities[a]===b){this._entities.splice(a,1);return}}};ViewClass.prototype.update=function(){this._ctx.clearRect(0,0,this.w,this.h);for(var a=0;a<this._entities.length;a++){this._entities[a].draw()}};ViewClass.prototype.drawCell=function(a,c,b){this.rect(a*this.cellW,c*this.cellH,this.cellW,this.cellH,b)};ViewClass.prototype.drawUpgradeItem=function(j,i,e,c){var m=this._ctx;var d=this.cellW*j+e;var a=d+this.cellW-2*e;var f=d+this.cellW_2-e;var k=this.cellH*i+e;var h=k+this.cellH-2*e;var g=k+this.cellH_2-e;m.lineWidth=10;m.strokeStyle=c;m.beginPath();m.moveTo(f,k);m.lineTo(f,h);m.moveTo(d,g);m.lineTo(a,g);m.stroke()};ViewClass.prototype.drawCellRhombus=function(j,i,e,c){var m=this._ctx;var d=this.cellW*j+e;var a=d+this.cellW-2*e;var f=d+this.cellW_2-e;var k=this.cellH*i+e;var h=k+this.cellH-2*e;var g=k+this.cellH_2-e;m.beginPath();m.moveTo(f,k);m.lineTo(a,g);m.lineTo(f,h);m.lineTo(d,g);m.closePath();m.fillStyle=c;m.fill()};ViewClass.prototype.drawCellCircle=function(a,d,c,b){this.circle(a*this.cellW+this.cellW_2,d*this.cellH+this.cellH_2,this.cellW-c,b)};ViewClass.prototype.rect=function(a,f,c,e,d){var b=this._ctx;b.fillStyle=d;b.fillRect(a,f,c,e)};ViewClass.prototype.circle=function(a,f,e,c){var b=this._ctx;b.beginPath();b.arc(a,f,e/2,0,2*Math.PI,false);b.fillStyle=c;b.fill()};ViewClass.prototype.line=function(c,f,b,d,e){var a=this._ctx;a.beginPath();a.moveTo(c,f);a.lineTo(b,d);a.strokeStyle=e;a.lineWidth=1;a.stroke()};var MapColors=new Object();MapColors.X="darkgrey";MapColors.x="white";MapColors[" "]="black";var MapGridColor="grey";var MapDimensions={w:10,h:10};var MapData=new Array("X","X","X","X"," ","x","x","X","P","x","P"," ","x"," ","X","x","x"," "," ","x","x"," ","X","x","X","X","x","x","x","X","X","x","x","x","x","x","x","X","x","X","X","X","X","x","X","x","X","x"," ","X","x","x","X","x","x","X","x","x","x","X","x"," ","x","x"," ","x","x","x","x","x","X","x","x","X","x","X","x","X","x","X","X","x","x","x","X","x","x","x"," ","P","P"," "," ","X","x","x","x","x"," ","X");function mapCellType(a,b){return MapData[b*MapDimensions.w+a]}function mapCellIsFree(a,c){var b=mapCellType(a,c);return(b===" "||b==="P"||b==="U")}function mapCellSet(a,c,b){MapData[c*MapDimensions.w+a]=b}MapClass.prototype=new EntityClass();MapClass.constructor=MapClass;function MapClass(){var b=MapDimensions.w;var c=MapDimensions.h;this._p2pComm=null;this._spawnPoints=new Array();for(var d=0;d<c;d++){for(var a=0;a<b;a++){if(MapData[d*b+a]==="P"){this._spawnPoints.push(new Array(a,d))}}}}MapClass.prototype.setP2PComm=function(a){this._p2pComm=a;this._p2pComm.setMsgHandler(MsgTypePlayerUpgrade,this,this.receivedUpgradeMsg)};MapClass.prototype.getSpawnPoints=function(){return this._spawnPoints};MapClass.prototype.draw=function(){var c=MapDimensions.w;var d=MapDimensions.h;for(var g=0;g<d;g++){for(var b=0;b<c;b++){var a=MapData[g*c+b];if(a!==" "&&a!=="P"&&a!=="B"&&a!=="U"){this._view.drawCell(b,g,MapColors[a])}else{if(a==="U"){this._view.drawUpgradeItem(b,g,10,"yellow")}}}}for(var g=0;g<d;g++){var e=g*this._view.cellH;this._view.line(0,e,c*this._view.cellW,e,MapGridColor)}for(var b=0;b<c;b++){var f=b*this._view.cellW;this._view.line(f,0,f,d*this._view.cellH,MapGridColor)}};MapClass.prototype.receivedUpgradeMsg=function(a,b){mapCellSet(b.pos[0],b.pos[1],"U")};BombClass.prototype=new EntityClass();BombClass.prototype.parent=EntityClass.prototype;BombClass.constructor=BombClass;function BombClass(){this._initialMargin=25;this._finalMargin=5;this._color="red";this._owner=null;this._timerMs=Conf.bombTimerMs;this._strength=0;this._playerManager=null;this._p2pComm=null;this._exploding=false;this._explBlocked=null;this._explWave=0;this._explStartMs=0;this._explMaxMs=500;this._bombDropTime=0;this._tickingBombFrame=0}BombClass.prototype.setup=function(c,b,a){this.parent.setup.call(this,c);this._playerManager=b;this._p2pComm=a};BombClass.prototype.draw=function(){if(this._exploding){this._drawExplAnim()}else{this._drawTickingBombAnim()}};BombClass.prototype.dropByPlayer=function(b){this._owner=b;var a=this._owner.x;var c=this._owner.y;this._strength=this._owner.getBombStrength();mapCellSet(a,c,"B");this.set(a,c);this._view.addEntityBeforeEntity(this,this._owner);this._bombDropTime=currentMs();window.setTimeout(function(){this.explode()}.bind(this),this._timerMs)};BombClass.prototype.explode=function(){if(this._strength==0){return}console.log("BOOM!");this._exploding=true;this._explWave=1;this._explStartMs=currentMs();this._explBlocked=new Array()};BombClass.prototype.stopExplosion=function(){console.log("BUFF!");this._exploding=false;this._explWave=0;this._explStartMs=0;mapCellSet(this.x,this.y," ");this._view.removeEntity(this)};BombClass.prototype._explDirectionIsBlocked=function(e,c){if(this._explBlocked.length>0){for(var a=0;a<this._explBlocked.length;a++){var d=this._explBlocked[a];if(d[0]==e&&d[1]==c){return true}}}return false};BombClass.prototype._checkPlayerHits=function(d,a){var e=this._playerManager.getPlayers();for(var c=0;c<e.length;c++){var b=e[c];if(b.getAlive()===true&&b.x===d&&b.y===a){b.setAlive(false);this._playerManager.checkGameStatus()}}};BombClass.prototype._drawExplAnim=function(){var b=currentMs()-this._explStartMs;if(b>=this._explMaxMs){if(this._explWave>=this._strength){this.stopExplosion();return}this._explStartMs=currentMs();this._explWave++}var k=b/this._explMaxMs;for(var j=-1;j<=1;j++){for(var l=-1;l<=1;l++){if(Math.abs(l)+Math.abs(j)==2){continue}if(this._explDirectionIsBlocked(l,j)){continue}var c=this.x+l*this._explWave;var a=this.y+j*this._explWave;if(c<0||c>=MapDimensions.w||a<0||a>=MapDimensions.h){continue}this._checkPlayerHits(c,a);if(l==0&&j==0){continue}var h=mapCellType(c,a);if(h==="X"){this._explBlocked.push(new Array(l,j));continue}if(h==="x"){var f=" ";if(this._owner.getType()!==PlayerTypeRemote&&Math.random()<Conf.upgradePossibility){f="U";if(gameMode===GameModeMultiplayer){var e={id:this._owner.getId(),type:MsgTypePlayerUpgrade,pos:new Array(c,a)};this._p2pComm.sendAll(e)}}mapCellSet(c,a,f)}var g=255-k*100;var i=30+k*127;var d=1-k;style="rgba("+g.toFixed()+", "+i.toFixed()+", 0, "+d.toFixed()+")";this._view.drawCell(c,a,style)}}};BombClass.prototype._drawTickingBombAnim=function(){this._tickingBombFrame=(this._tickingBombFrame+1)%60;var c=this._finalMargin-this._initialMargin;var d=this._initialMargin+(currentMs()-this._bombDropTime)*c/this._timerMs;var b=this._finalMargin-c;var e=d+b/2*Math.sin(Math.PI*(this._tickingBombFrame/60));this._view.drawCellCircle(this.x,this.y,e,this._color)};function ControlsClass(){this._player=null;this._lastBombKeyUsage=0;this._lastMoveKeyUsage=0}ControlsClass.prototype.setup=function(b,a){this._player=b;$(document).bind("keydown",a[0],function(){this.moveLeft()}.bind(this));$(document).bind("keydown",a[1],function(){this.moveRight()}.bind(this));$(document).bind("keydown",a[2],function(){this.moveUp()}.bind(this));$(document).bind("keydown",a[3],function(){this.moveDown()}.bind(this));$(document).bind("keydown",a[4],function(){this.dropBomb()}.bind(this))};ControlsClass.prototype.moveLeft=function(){if(currentMs()-this._lastMoveKeyUsage<Conf.moveKeyRepeatTimeMs){return}this._lastMoveKeyUsage=currentMs();this._player.moveBy(-1,0)};ControlsClass.prototype.moveRight=function(){if(currentMs()-this._lastMoveKeyUsage<Conf.moveKeyRepeatTimeMs){return}this._lastMoveKeyUsage=currentMs();this._player.moveBy(1,0)};ControlsClass.prototype.moveUp=function(){if(currentMs()-this._lastMoveKeyUsage<Conf.moveKeyRepeatTimeMs){return}this._lastMoveKeyUsage=currentMs();this._player.moveBy(0,-1)};ControlsClass.prototype.moveDown=function(){if(currentMs()-this._lastMoveKeyUsage<Conf.moveKeyRepeatTimeMs){return}this._lastMoveKeyUsage=currentMs();this._player.moveBy(0,1)};ControlsClass.prototype.dropBomb=function(){if(currentMs()-this._lastBombKeyUsage<Conf.bombKeyRepeatTimeMs){return}this._lastBombKeyUsage=currentMs();this._player.dropBomb()};